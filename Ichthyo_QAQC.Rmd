---
title: "Ichthyo_QAQC"
author: "Lisa Vance"
date: "2024-02-13"
output: html_document
editor_options: 
  chunk_output_type: console
---
YBFMP Ichtyoplankton Data 1998 - 2022

```{r set-options, echo=FALSE, cache=FALSE}

options(width = 10000)
```

## Setup

1. Set up and load libraries

```{r setup, results=FALSE, warning = FALSE, message = FALSE}

rm(list=ls(all=TRUE))

library(tidyverse)
library(dplyr)
library(ggplot2)
library(knitr)
library(gridExtra)
library(stringr)
library(plotly)
library(viridis)
library(kableExtra)
library(lubridate)
library(readxl)
library(readr)
library(anytime)
library(magrittr)
library(janitor)
library(tidylog)
```

2. Load data and check variable types
Note data is in both MS Access and MS Excel
Physical data is shared between drift and ichthyo since tows are done at the same time and site

```{r load, results = FALSE, warning = FALSE, message = FALSE}

################# bring in qa/qc physical data #################################
PhysData <-read_csv("drift data/LT_phys_qc_20240118.csv")

######### Read in Access catch data ###########################################

CatchData <- read_csv("ichthyo data/TblLarvalCatchDataAccess.csv")
Species <- read_csv("ichthyo data/TblLarvalLookUpV2.csv")
SamplingData <- read_csv("ichthyo data/TblLarvalSampAccess.csv")
Sampling2 <- read_csv("ichthyo data/IchSampData.csv", skip = 1)
IEPFish <- read_csv("ichthyo data/IEP FISH CODE.csv")

########## Read in Excel Catch data ###########################################

#note there was a transciption error for time sent to contractors on COC for 5/6/2019 - corrected
# in csv (9:56 incorrect, 9:53 correct per datasheet)

IchLabData <- read_csv("ichthyo data/IchLabExcelData.csv", skip=1)

######## Bring in Inundation data and Water Year type Data ###################
wy <- read_csv("WaterYearType_CDEC.csv") 
inundation <- read_csv("Yolo_Bypass_Inundation_1998-2022.csv")

```

3. Rename some columns and drop any unnecessary columns
```{r filter, results = FALSE, message = FALSE, warning = FALSE}

Species <- Species %>%
  rename (SpeciesCode = "Code",
          CommonName = "Species",
          ScientificName = "Scientific Name")
View(Species)

SamplingData <- SamplingData %>%
  rename (SamplingQAQCByAccess = "QA/QC'dBy",
          SamplingEnteredByAccess = 'EnteredBy',
          FieldCommentsLarval = "FieldComments") %>%
  select(-c(SamplingEnteredByAccess, SamplingQAQCByAccess))
View(SamplingData)

IEPFish <- IEPFish %>%
  select(-c("...5":"...17"))
View(IEPFish)

PhysData <- PhysData %>%
  select(-c(MeterSetTime, FlowMeterStart, FlowMeterEnd, FlowMeterSpeed, ConditionCode))
#these flow meter values relate to drift data, not ichthyo

CatchData <- CatchData %>%
  rename(CommentsCatch = Comments)
#help distinguish comments columns

IchSampling <- Sampling2 %>%
  rename(Program = 'Measuring program short name',
         Date = 'Sampling Event Date',
         Time = 'Sampling Event Time',
         Station = 'Sampling Area Number',
         SamplingNumber = 'Sampling Event Number',
         PhysicalDataID = '...6',
         ConditionCode = 'Condition Code',
         SamplingAltered = 'Sampling Altered',
         MeterSetTime = 'Set Time',
         FlowMeterStart = 'Flow Meter Start',
         FlowMeterEnd = 'Flow Meter End',
         FlowMeter50Start = 'Flow Meter Start (50)',
         FlowMeter50End = 'Flow Meter End (50)',
         FlowMeterSpeed = 'Flow Meter Speed',
         PhysicalDataIDx = 'Physical Data ID',
         EnteredBy = 'Entered by',
         QAQCBy = "QAQC'd by",
         FieldCommentsExcel = 'Field Comments',
         LabComments = 'Lab Comments',
         SampleVolume = 'Sample Volume',
         SubsampleNumber = 'Subsample Number',
         DilutionVolume = 'Dilution Volume',
         SlideCount = 'Slide Count',
         MeshSize = 'Observation Area Name',
         Observation = 'Observation Area Number',
         SpotNumber = 'Spot Number',
         SpotCode = 'Spot Code (original/duplicate)')

```

4. Adjust Channel Location Column in Access data; Combine QA/QC'd physical data with larval sampling data and rename those columns. In 2015 tows were done to determine if channel location created bias in sampling.
```{r}

CatchSpecies <- left_join(CatchData, Species)
View(CatchSpecies)

#using "center" as default if no channel location is specified as most tows are done as center of channel as possible following SOPs

CatchSpecies2 <- mutate(CatchSpecies, ChannelLocation = case_when(is.na(ChannelLocation) ~ "Center", TRUE ~ ChannelLocation))

IchSample <- left_join(PhysData, SamplingData, by = "PhysicalDataID")
View(IchSample)

# rename columns to help simplify before pivoting to simplify column names and make tidy

IchSample2 <- IchSample %>%
  rename(Start_MidWest = "LarvalStartMeter_Mid_West",
         End_MidWest = "LarvalEndMeter_Mid_West",
         Start_NearWest = "LarvalStartMeter_Near_West",
         End_NearWest = "LarvalEndMeter_Near_West",
         Start_MidEast = "LarvalStartMeter_Mid_East",
         End_MidEast = "LarvalEndMeter_Mid_East",
         Start_NearEast = "LarvalStartMeter_Near_East",
         End_NearEast = "LarvalEndMeter_Near_East",
         Start_MidBottom = "LarvalStartMeter_Mid_Bottom",
         End_MidBottom = "LarvalEndMeter_Mid_Bottom") %>%
  select(-c(StartTime, StopTime, "2ndStartTime_East", "2ndStopTime_East",
            Bottom_StartTime))
View(IchSample2)

#now use pivot longer to create separate columns of "meter start" and "location"

StartPivot <- pivot_longer(IchSample2,
                           cols = c(Start_MidWest, Start_NearWest,
                                    Start_MidEast, Start_NearEast,
                                    Start_MidBottom, LarvalStartMeter), 
                           names_to = c("TowLocation"),
                           values_to = c("StartValue"),
                           names_prefix = c("Start_"),
                           values_drop_na = TRUE) %>%
  select(-c(End_MidWest, End_NearWest,
            End_MidEast, End_NearEast, 
            End_MidBottom, LarvalEndMeter)) %>%
  mutate(TowLocation = case_when(TowLocation == "LarvalStartMeter" ~ "Center",
                                 TowLocation == "MidWest" ~ "Mid_West",
                                 TowLocation == "MidEast" ~ "Mid_East",
                                 TowLocation == "NearWest" ~ "Near_West",
                                 TowLocation == "NearEast" ~ "Near_East",
                                 TowLocation == "MidBottom" ~ "Bottom",
                                 TRUE ~ TowLocation))
View(StartPivot)

EndPivot <- pivot_longer(IchSample2,
                         cols = c(End_MidWest, End_NearWest,
                                  End_MidEast, End_NearEast,
                                  End_MidBottom, LarvalEndMeter), 
                         names_to = c("TowLocation"),
                         values_to = c("EndValue"),
                         names_prefix = c("End_"),
                         values_drop_na = TRUE) %>%
  select(-c(Start_MidWest, Start_NearWest,
            Start_MidEast, Start_NearEast, 
            Start_MidBottom, LarvalStartMeter)) %>%
  mutate(TowLocation = case_when(TowLocation == "LarvalEndMeter" ~ "Center",
                                 TowLocation == "MidWest" ~ "Mid_West",
                                 TowLocation == "MidEast" ~ "Mid_East",
                                 TowLocation == "NearWest" ~ "Near_West",
                                 TowLocation == "NearEast" ~ "Near_East",
                                 TowLocation == "MidBottom" ~ "Bottom",
                                 TRUE ~ TowLocation))
View(EndPivot)

Pivot1 <- left_join(StartPivot, EndPivot)
View(Pivot1)

Pivot3 <- filter(Pivot1, !is.na(LarvalDataID)) %>%
  left_join(CatchSpecies2, by = c("LarvalDataID", "TowLocation" = "ChannelLocation"))
View(Pivot3)

# larval code mainly utilized for linking things in access database, now that 
# things are linked, not necessary to keep so can be dropped here

IchAccess <- Pivot3 %>%
  filter(Station == "STTD" | Station == "SHR") %>%
  select(-c(LarvalCode.x, LarvalCode.y)) %>%
  rename(FieldCommentsAccess = "FieldComments") %>%
  relocate(event_id, Datetime)
View(IchAccess)

# this ensures looking at data that is in access, not excel
# this means these larvaldataID are not affected by the data gap to address
# between access and excel
# some of these NA are "no catch" and not blanks - think about a solution? 110 values
# early data (i.e. 1998 -2003 not found via contractor data records...)

# narrow down how many can be confirmed "no catch" (2010 onward) versus
# how many must be marked as "no data" (2009 and earlier) due to not being able 
# to confirm with contractor data and verifying it's not an additional mistaken entry

viewNA <- filter(IchAccess, is.na(LarvalCatchID))
# some include the data gap between access and excel

viewAccessNA <- filter(viewNA, year(Date) < 2019)


AccessNA <- filter(viewAccessNA, year(Date) >= 2010 & year(Date) < 2019)
AccessNoData <- filter(viewAccessNA, year(Date) < 2010)

# now rename each group of data appropriately and ensure # replaced values equal to 
# what was narrowed down between the two date ranges
NOSpecimens = mutate(IchAccess, SpeciesCode = case_when(IchAccess$Date %in% viewAccessNA$Date & year(Date) >= 2010
                                                        & year(Date) < 2019 & is.na(SpeciesCode) ~ 
                                                          "NONE", TRUE ~ SpeciesCode))

NoData = mutate(NOSpecimens, SpeciesCode = case_when(IchAccess$Date %in% viewAccessNA$Date & year(Date) < 2010
                                                     & is.na(SpeciesCode) ~ "NODATA", TRUE ~ SpeciesCode))

IchAccessA <- NoData
#this should have a date/time column for ease of combining with excel data later on
```

5. Filter the data that came from Access to account for divisions of physical, sampling, and lab data collection due to changes in anticipated database formats. 4/22/2019 catch/lab data was entered into Excel. Sampling data for 01/06/2020 and 01/27/2020 were entered into both Access and Excel but Excel has the corresponding field comments.Rename flowmeter columns so no excessive columns when bound with Excel data.
```{r}
#lab data in excel 4-22-19 onward. Access phys data through 1/27/2020
#filter physical data file to account for this overlap
Phys2019 <- PhysData %>% 
  filter(Date > "2019-04-16" & Date < "2020-01-01")

#access data that does not overlap with excel
#this is full data - physical, sampling, catch that is in access
IchAccessB <- IchAccessA %>%
  filter(Date< "2019-04-22")%>%
  rename(FlowMeterStart = StartValue,
         FlowMeterEnd = EndValue,
         MeterSetTime = SetTime)%>%
  select(-c(FieldCommentsAccess))

#access data that does overlap with excel. 
IchAccessC <- IchAccessA %>%
  filter(Date > "2019-04-16" & Date < "2020-01-01")%>%
  rename(FlowMeterStart = StartValue,
         FlowMeterEnd = EndValue,
         MeterSetTime = SetTime)%>%
  select(-c(FieldCommentsAccess))
```


 Clean up columns and formatting for the sampling data from Excel, for ease of combining data before binding
```{r}
IchSampling <- Sampling2 %>%
  rename(Program = 'Measuring program short name',
         Date = 'Sampling Event Date',
         Time = 'Sampling Event Time',
         Station = 'Sampling Area Number',
         SamplingNumber = 'Sampling Event Number',
         PhysicalDataID = '...6',
         ConditionCode = 'Condition Code',
         SamplingAltered = 'Sampling Altered',
         MeterSetTime = 'Set Time',
         FlowMeterStart = 'Flow Meter Start',
         FlowMeterEnd = 'Flow Meter End',
         FlowMeter50Start = 'Flow Meter Start (50)',
         FlowMeter50End = 'Flow Meter End (50)',
         FlowMeterSpeed = 'Flow Meter Speed',
         PhysicalDataIDx = 'Physical Data ID',
         EnteredBy = 'Entered by',
         QAQCBy = "QAQC'd by",
         FieldCommentsExcel = 'Field Comments',
         LabComments = 'Lab Comments',
         SampleVolume = 'Sample Volume',
         SubsampleNumber = 'Subsample Number',
         DilutionVolume = 'Dilution Volume',
         SlideCount = 'Slide Count',
         MeshSize = 'Observation Area Name',
         Observation = 'Observation Area Number',
         SpotNumber = 'Spot Number',
         SpotCode = 'Spot Code (original/duplicate)')

View(IchSampling)

#filtering the na rows removes the excess at the end of the file and the descriptor row without losing column names
IchSampling2 <- filter(IchSampling, !is.na(Program))

#mutating date and time into date/time column for ease of combining data

IchSampling2$Date<-as.Date(IchSampling2$Date,"%m/%d/%Y")
IchSampling2$Year <- year(IchSampling2$Date)
IchSampling2$Month <- month(IchSampling2$Date)
mymonths <- c("Jan","Feb","Mar",
              "Apr","May","Jun",
              "Jul","Aug","Sep",
              "Oct","Nov","Dec")
IchSampling2$MonthAbb <- mymonths[ IchSampling2$Month ]
IchSampling2$Datetime = paste(IchSampling2$Date, IchSampling2$Time)
IchSampling2$Datetime <- ymd_hm(IchSampling2$Datetime)
IchSampling2$Time <- strptime(IchSampling2$Time, format = "%H:%M", tz = "") %>%
  strftime(IchSampling2$Time, format = "%H:%M:%S", tz = "", usetz = FALSE)
IchSampling2$Time <- hms::as_hms(IchSampling2$Time)

#filtering the rows helps to remove the demonstration data that was in the file
IchSampling2 <- filter(IchSampling2, year(Date)>2018)
View(IchSampling2)

#drop unnecessary columns and create event id column for ease of merging with phys data and catch data
IchSampling3 <- IchSampling2 %>%
  select(-c(PhysicalDataID, PhysicalDataIDx, FlowMeter50Start, FlowMeter50End,
            EnteredBy, QAQCBy, SpotCode, SpotNumber, Observation, Program, SamplingNumber,
            SubsampleNumber,DilutionVolume,SlideCount)) %>%
  mutate(event_id = paste0(Station, "_", Datetime)) %>%
  relocate(event_id, Datetime) %>%
  filter(year(Date)<2023)
View(IchSampling3)
```

 Now split the sampling from Excel to account for overlap between Access and Excel. Dates 01/06/2020 and 01/27/2020 sampling was entered into both Access and Excel. The appropriate comments for sampling data are housed in the Excel files so utilize that. Also create a data frame housing just the sampling data for 4/22/2019 through 7/15/2019 - that sampling data and physical data was entered into Access, but due to the delay in receiving confirmation of catch data from contractors the lab data was entered into Access
```{r}
#2020 overlap between access and excel
IchOverlap <- IchSampling3 %>%
  filter(Date == "2020-01-06" | Date == "2020-01-27")

#filtering the rest of the access data that is not the above two dates to move forward
IchSampling4 <- IchSampling3 %>%
  filter(!(Date == "2020-01-06" | Date == "2020-01-27"))

```

 Now clean up the columns and formatting for the lab data that came back 2019 onward that is housed in Excel. This will eventually be combined with the data from Access so that the complete data set is in one data frame.
```{r}
#bring in lab data from Excel, then separate to what does and does not overlap
IchLabData <- IchLabData %>%
  rename(Program = 'Measuring program short name',
         Date = 'Sampling Event Date',
         Time = 'Sampling Event Time',
         Station = 'Sampling Area Number',
         SamplingNumber = 'Sampling Event Number',
         SampleID = 'Sample ID',
         OrganismType = 'Observation Type Short Name',
         OrganismGroup = 'Attribute',
         ScientificName = 'Observable',
         TotalCountSpecies = 'Value...10',
         TL = 'Value...11',
         FL = 'Value...12',
         LifeStage = 'Value...13',
         LarvalLifeStage = '...14',) %>%
  filter(!is.na(Program)) %>%
  select(-c(SamplingNumber, SampleID, Program, OrganismType, OrganismGroup))

#format date and time columns for ability to combine with Access data
IchLabData$Date<-as.Date(IchLabData$Date,"%m/%d/%Y")
IchLabData$Year <- year(IchLabData$Date)
IchLabData$Month <- month(IchLabData$Date)
mymonths <- c("Jan","Feb","Mar",
              "Apr","May","Jun",
              "Jul","Aug","Sep",
              "Oct","Nov","Dec")
IchLabData$MonthAbb <- mymonths[ IchLabData$Month ]
IchLabData$Datetime = paste(IchLabData$Date, IchLabData$Time)
IchLabData$Datetime <- ymd_hm(IchLabData$Datetime)
IchLabData$Time <- strptime(IchLabData$Time, format = "%H:%M", tz = "") %>%
  strftime(IchLabData$Time, format = "%H:%M:%S", tz = "", usetz = FALSE)
IchLabData$Time <- hms::as_hms(IchLabData$Time)

IchLabData2 <- IchLabData %>%
  mutate(event_id = paste0(Station, "_", Datetime)) %>%
  relocate(event_id, Datetime)%>%
  filter(year(Date)<2023)

#combine lab data with "sampling data to ensure no missing field comments for ich tows

#create two lab data frames. one 4-22-2019 to end of 2019, one 2020 to 2022
IchLab2019 <- IchLabData2 %>%
  filter(year(Date) == 2019) %>%
  mutate(FL = as.numeric(FL))

IchLabExcel <- IchLabData2 %>%
  filter(year(Date) > 2019)

#correct any scientific name misspellings before adding species codes
IchLab2019$ScientificName <- str_replace_all(IchLab2019$ScientificName, "Menidia berylina", "Menidia beryllina")
IchLabExcel$ScientificName <- str_replace_all(IchLabExcel$ScientificName, "Menidia berylina", "Menidia beryllina")

```

 Add in some updates to the species dataframe to account for changes in contractor notation of ID'd species
```{r}
#additional items for species due to changes in contractor notation
#per contractor form Menidia sp. = common name silverside
# between lab data in excel and lab data from access, add to the 
# species lookup table to cover everything for joining 
SpeciesUpdate <- Species %>%
  add_row(SpeciesCode = "UNSS" , CommonName = "silverside", ScientificName = "Menidia sp.") %>%
  add_row(SpeciesCode = "POM", CommonName = "Unid Crappie", ScientificName = "Pomoxis sp.") %>%
  add_row(SpeciesCode = "NONE", CommonName = "NoCatch", ScientificName = "No Catch") %>%
  add_row(SpeciesCode = "RAIKIL", CommonName = "Rainwater Killifish", ScientificName = "Lucania parva") %>%
  add_row(SpeciesCode = "KLF", CommonName = "Killifish", ScientificName = "Cyprinodontidae spp.")

# removing TSE - threadfin shad eggs and ASE american shad eggs in this version 
# since it does not appear contractor has made a comment re: eggs
# also the "animal tissue, baby clam, etc" is removed since those NA don't match
# correctly when tied to the excel data
SpeciesUpdate2 <- SpeciesUpdate %>%
  filter(!is.na(ScientificName)) %>%
  filter(SpeciesCode != "TSE") %>%
  filter(SpeciesCode != "ASE")

#now add species codes and common names before joining data
IchLab2019S <- left_join(IchLab2019, SpeciesUpdate2)

IchLabExcelS <- left_join(IchLabExcel, SpeciesUpdate2)
```


 Merge each section of data with catch data before binding rows together
```{r}
#2020 overlap between access and excel
IchOverlapCatch <- left_join(IchOverlap, IchLabExcelS)%>%
  rename(FieldComments = FieldCommentsExcel)

#remainder of data strictly entered into Excel merge with catch
IchExcelCatch <- left_join(IchSampling4, IchLabExcelS)%>%
  rename(FieldComments = FieldCommentsExcel)%>%
  filter(Station == "STTD")
#removes the times ich net was used at SHR for comparison - no actual tow done

#next step is binding these to the 2019 overlap
#phys2019, ichaccessC, and ichlab2019
#sampling2019 is for ichthyo only - phys data file has both drift and ich - ich is not done at shr and last ich tow in 2019 was july
Sampling2019 <- left_join(Phys2019, IchAccessC) %>%
  filter(!(Station == "SHR")) %>%
  filter(!(is.na(FlowMeterStart))) %>%
  select(-c(ScientificName, TL, FL, SpeciesCode, CommonName, FieldComments))

#now to combine that sampling data with the lab data to get full catch
IchCatch2019 <- left_join(Sampling2019, IchLab2019S)

#bind access to 2019, then bind that combined dataframe to excel
IchAccessOverlap <- bind_rows(IchAccessB, IchCatch2019)

IchAccessOverlapA <- IchAccessOverlap %>%
  rename(FieldComments = FieldCommentsLarval,
         LabComments = CommentsCatch)

#making sure to add in water quality data to catch and sampling data
PhysExcel <- PhysData %>%
  filter(year(Date) > 2019) %>%
  filter(Station == "STTD")

PhysExcelOverlap <- PhysExcel %>%
  filter(Date == "2020-01-06" | Date == "2020-01-27") %>%
  select(-c(FieldComments, MeshSize))

PhysExcelB <- PhysExcel %>%
  filter(Date >= "2020-02-10") %>%
  select(-c(FieldComments, MeshSize, SamplingAltered)) %>%
  filter(Date < "2022-07-01") %>%
  filter(Station == "STTD") %>%
  unique()

IchOverlapCatchA <- left_join(PhysExcelOverlap, IchOverlapCatch)
IchExcelCatchA <- left_join(IchExcelCatch, PhysExcelB)

#Due to shifting lower trophic data into Excel for storage based on a database format, lab data from 4/22/2019 onward has a "TotalCountSpecies" column along with up to 20 individual larval fish measurements. This could be confusing for users unfamiliar, so adding an "count" column before binding dataframes together should help with this. 

IchExcelOverlap <- bind_rows(IchOverlapCatchA, IchExcelCatchA) %>%
  mutate(FL = as.numeric(FL))%>%
  mutate(CountIndividual = if_else(TotalCountSpecies >= 1, 1, NA))%>%
  group_by(event_id, PhysicalDataID, Datetime, Date, Time, Station, YSI, WeatherCode,Tide, MicrocystisVisualRank,
           WaterTemperature, Secchi, Conductivity, SpCnd, pH, DO, Turbidity, FlowDirection, VegetationRank, ConditionCode,
           SamplingAltered,FieldComments_WQ, Flag_PQC, Comment_PQC, DataCorrectionComments, Year, Month, MonthAbb,
           MeterSetTime, FlowMeterStart, FlowMeterEnd, FlowMeterSpeed,MeshSize, FieldComments,
           SampleVolume, LabComments, SpeciesCode, ScientificName, CommonName, TL,
           FL, LifeStage, LarvalLifeStage, TotalCountSpecies, CountIndividual) %>%
  summarise(Count = sum(CountIndividual))

IchFullData <- bind_rows(IchAccessOverlap, IchExcelOverlap)

#write to a csv for ease of future publishings
#export bound file
write_csv(IchFullData, "test files/IchFullData1998-2022.csv")

```

 Ensure columns are in a good order, Find unique values. Create data frame with water year and water type added in for analysis in QA/QC.
```{r}
IchFullData <- IchFullData%>%
  relocate(event_id, Datetime, Date, Time, PhysicalDataID, Station, YSI, WeatherCode, Tide, FlowDirection,
           ConditionCode, VegetationRank, MicrocystisVisualRank, WaterTemperature, Secchi, Conductivity, SpCnd, 
           pH, DO, Turbidity, MeterSetTime, FlowMeterSpeed, FlowMeterStart, FlowMeterEnd, TowLocation, SampleVolume)

sampUnique <- IchFullData %>%
  unique() %>%
  arrange(Datetime)

samp_catch_physMerge <- IchFullData %>%
  mutate(WY = ifelse(Month >9, Year + 1, Year)) %>%
  left_join(wy, by = "WY") %>%
  select(-c(Index, WYType)) %>%
  mutate(Flowdiff = abs(FlowMeterEnd-FlowMeterStart))

```

## QAQC 

* QC Flags: Blank = no issues/1 = Comment but deemed Acceptable/ 2 = Suspect/ 3 = Highly Suspect
* Flag_SAMP: Sampling issues
* Flag_LAB: Lab issues
* Flag_FM: Flowmeter
* Flag_CPUE: CPUE

### QAQC Sampling and Lab issues

6. Export sampling table
7. Look at field sampling comments
8. Flag comments reflecting poor data quality (Flag_SAMP)
9. Add comment about what was flagged
    * FMMISSING if lacking flowmeter values
    * SAMP for other sampling issues 
    * Leave blank if no issues
10. Look at lab comments and flag if poor data quality
11. Add Comment_LAB
    * LAB if lab issues (e.g. unable to meet meso or microtally)
    * Leave blank if no issues

* This part is manual. Think about how to make this codeable, change our condition code flags or add a flag as part of data entry? 
* The following section creates blank columns before creating the csv to manually filter through comments and add appropriate notation before reading the file back in at step 12


```{r}
SamplingQAQC <- filter(sampUnique, !is.na(FieldComments) | ConditionCode>1 | !is.na(LabComments))
SamplingQAQC$Flag_SAMP <-  ""
SamplingQAQC$Comment_SAMP <-""
SamplingQAQC$Flag_LAB <- ""
SamplingQAQC$Comment_LAB <- ""
today <- today()
write.csv(SamplingQAQC, paste("R_write/IchSamplingQAQC_", today, ".csv"))
```

Now that file is notated, read back in and select for the flags and comments. 
```{r}
SamplingQAQC_fill <- read.csv("R_write/IchSamplingQAQC_Notated_2024-06-20.csv")
SamplingQAQC_fill_s <- SamplingQAQC_fill %>%
  select(c(event_id, PhysicalDataID, Flag_SAMP, Comment_SAMP, Flag_LAB, Comment_LAB))
```

### QAQC Flowmeters

13. Inundation data

    This data comes from Water Data Library, Stations at Fremont Weir (A02170) and I Street Bridge . If Stage Height > 32ft at Fremont Weir, Inundation = TRUE. If there is no data at Fremont Weir, and Stage Height > 17 ft at I Street Bridge, Inundation = TRUE. There was also 2 days of lag time added in for inundation (variable Inundation2). 
    
* Inundation used to QA/QC STTD data. 

```{r}
#first make sure inundation columns match ich data frame 
inundation <- inundation %>%
  rename(Date = Dates)
inundation$Date<-as.Date(inundation$Date,"%m/%d/%Y")

inundation2 <- inundation %>%
  mutate(Month = month(Date),
         Year = year(Date),
         WY = ifelse(Month > 9, Year + 1, Year)) %>%
  select(-c(Month, Year))

inundation2a <- inundation %>%
  mutate(Month = month(Date),
         Year = year(Date),
         WY = ifelse(Month > 9, Year + 1, Year))

# Modify sample table to include Flowdiff
samp3 <-sampUnique %>%
  mutate(Flowdiff = abs(FlowMeterEnd-FlowMeterStart),
         Flowdiff_s = Flowdiff/MeterSetTime) 

# merged inundation and sampling
inundation_flow <- left_join(samp3, inundation2, by = "Date") %>%
  filter(Flowdiff<100000) %>%
  filter(Station == "STTD") %>%
  mutate(Flowdiff_s = Flowdiff/MeterSetTime,
         Inundation_n = ifelse(Inundation == "TRUE", 40000, 0))

# all inundation
inundation3 <- inundation %>%
  mutate(Inundation_n = ifelse(Inundation == "TRUE", 40000, 0),
         Inundation_n_low = ifelse(Inundation == "TRUE", 5000,0))

# Plot - only inundation events that correspond with sampling date
inplot1 <- ggplot(inundation_flow) + 
  geom_point(aes(x = Date, y = Flowdiff)) + 
  geom_col(aes(x = Date, y = Inundation_n), fill = "blue", linewidth = 2) + 
  labs(title = "Flowdiff with Inundation events corresponding with sample dates") +
  facet_grid(Station~.) +
  theme_bw()

ggplotly(inplot1)

# Plot - All inundation events
inplot2 <- ggplot() +
  geom_point(data = inundation_flow, aes(x = Date, y = Flowdiff)) +
  labs(title = "Flowdiff with all Inundation") +
  geom_col(data = inundation3, aes(x = Date, y = Inundation_n), fill = 
             "blue", alpha = 0.6) + theme_bw()
ggplotly(inplot2)

inplot3 <- ggplot() +
  geom_point(data = inundation_flow, aes(x = Date, y = Flowdiff_s)) +
  labs(title = "Standardized Flowdiff with all Inundation") +
  geom_col(data = inundation3, aes(x = Date, y = Inundation_n_low), fill = 
             "blue", alpha = 0.6) + theme_bw()

grid.arrange(inplot1, inplot2, inplot3, nrow = 3)


# Allow 10 days after last "inundation=TRUE" to also count as inundated. Merge with sample data. 
inundation4 <- inundation2a %>%
  mutate(Inundation2 = ifelse(lead(Inundation, 10) == "TRUE", "TRUE", Inundation)) %>%
  select(c(Date, Month:Inundation2))

inundation4$Inundation2[inundation4$Date=="1998-01-01"] <- "FALSE"
inundation4$Inundation2[inundation4$Date=="1998-01-02"] <- "FALSE"
inundation4$Inundation2[inundation4$Date=="1998-01-03"] <- "FALSE"
inundation4$Inundation2[inundation4$Date=="1998-01-04"] <- "FALSE"
inundation4$Inundation2[inundation4$Date=="1998-01-05"] <- "FALSE"
inundation4$Inundation2[inundation4$Date=="1998-01-06"] <- "FALSE"
inundation4$Inundation2[inundation4$Date=="1998-01-07"] <- "FALSE"
inundation4$Inundation2[inundation4$Date=="1998-01-08"] <- "FALSE"
inundation4$Inundation2[inundation4$Date=="1998-01-09"] <- "FALSE"
inundation4$Inundation2[inundation4$Date=="1998-01-10"] <- "FALSE"

samp_catch_phys <- left_join(samp_catch_physMerge, inundation4)
```

Flowmeter QA/QC

Look at distribution of flowmeter values
```{r}
# Histogram of values
samp_catch_phys$Month <- ordered(samp_catch_phys$Month)
FlowHist <- ggplot(samp_catch_phys, aes(Flowdiff)) + geom_histogram() +
  facet_wrap(~Station) + theme_bw()
ggplotly(FlowHist)

# SHR vs STTD boxplot
FlowBox <- ggplot(samp_catch_phys) + geom_boxplot(aes(x = Station, y = Flowdiff)) + theme_bw()

# SHR vs STTD boxplot by month
FlowBoxMonth <- ggplot(samp_catch_phys) + geom_boxplot(aes(x = Month, y = Flowdiff, fill = Month)) + facet_wrap(~Station) + scale_fill_viridis(discrete = TRUE) + theme_bw() 

# SHR vs STTD boxplot by year
FlowBoxYear <- ggplot(samp_catch_phys) + geom_boxplot(aes(x = ordered(WY), y = Flowdiff, fill = ordered(WY))) + facet_wrap(~Station) + theme_bw() 

# SetTime vs Flowdiff by station and month
FlowPoint <- ggplot(samp_catch_phys, aes(x = MeterSetTime, y = Flowdiff, color = Month)) + geom_point(size = 3) + facet_wrap(~Station) + theme_bw()

# SetTime vs Flowdiff by station and flowmeter type
FlowPoint2 <- ggplot(samp_catch_phys, aes(x = MeterSetTime, y = Flowdiff, color = FlowMeterSpeed)) + geom_point(size = 3) + facet_wrap(~Station) + theme_bw() + scale_color_viridis(discrete = TRUE) 


grid.arrange(FlowBox, FlowHist)
grid.arrange(FlowBoxMonth, FlowBoxYear)
grid.arrange(FlowPoint, FlowPoint2)
```


Make adjustments to known flowmeter errors from looking at any values outside of expected range
```{r}

checkich <- samp_catch_phys %>% filter(Flowdiff > 40000)

#fix known flowmeter errors
#flowmeter when it reads 0, use as if it reads 1000000

samp_catch_phys$Flowdiff[samp_catch_phys$event_id == "STTD_2015-04-30 08:16:00"] <- 1000000-996009
samp_catch_phys$FlowMeterEnd[samp_catch_phys$event_id == "SHR_2016-03-17 08:25:00"] <- 954818
samp_catch_phys$Flowdiff[samp_catch_phys$event_id == "SHR_2016-03-17 08:25:00"] <- 954818-941900

#comment on data sheet and confirmation with NI, 7/25/2012 STTD flowmeter value was recorded incorrectly, should match flowmeter for zoop
samp_catch_phys$FlowMeterEnd[samp_catch_phys$event_id == "STTD_2012-07-25 10:11:00"] <- 899989
samp_catch_phys$Flowdiff[samp_catch_phys$event_id == "STTD_2012-07-25 10:11:00"] <- 900000-899989

# 1/24/2012 SHR appears to be correct numbers based on datasheet but flow diff very high
# 1/23/2004 SHR appears to be correct numbers based on datasheet but flow diff very high
# 2/16/1999 SHR appears to be correct numbers based on datasheet but flow diff very high

#change the same flowmeter values in samp3
samp3$Flowdiff[samp3$event_id == "STTD_2015-04-30 08:16:00"] <- 1000000-996009
samp3$FlowMeterEnd[samp3$event_id == "SHR_2016-03-17 08:25:00"] <- 954818
samp3$Flowdiff[samp3$event_id == "SHR_2016-03-17 08:25:00"] <- 954818-941900

#comment on data sheet and confirmation with NI, 7/25/2012 STTD flowmeter value was recorded incorrectly, should match flowmeter for zoop
samp3$FlowMeterEnd[samp3$event_id == "STTD_2012-07-25 10:11:00"] <- 899989
samp3$Flowdiff[samp3$event_id == "STTD_2012-07-25 10:11:00"] <- 900000-899989

#remaining outlier values will be flagged in later qa/qc of flowmeter values

```

Merge data with lab/sampling QAQC 
```{r}

FM_Samp <- left_join(samp_catch_phys, SamplingQAQC_fill_s, by = "event_id")

FM_Samp <- left_join(samp_catch_phys, SamplingQAQC_fill_s, by = "event_id") %>%
  mutate(Flag_SAMP = replace(Flag_SAMP, is.na(Flag_SAMP), "" ),
         Comment_SAMP = replace(Comment_SAMP, is.na(Comment_SAMP), ""),
         Flag_LAB = replace(Flag_LAB, is.na(Flag_LAB), ""),
         Comment_LAB = replace(Comment_LAB, is.na(Comment_LAB), "")) %>%
  select(-c(PhysicalDataID.y))%>%
  rename(PhysicalDataID = "PhysicalDataID.x")


```

Make a table of summarized flowmeter values for different conditions
    * Use Flowdiff/Settime to look for outliers
    * Use inundation as a grouping variable for STTD but not SHR
```{r}
#removed meter set times that were NA due to errors in code
Flow.sum.STTD <- samp3 %>%
  left_join(inundation4) %>%
  left_join(wy)%>%
  filter(!is.na(Flowdiff), !is.na(Inundation2),!is.na(MeterSetTime), Station=="STTD") %>%
  mutate(Flow_s = Flowdiff/MeterSetTime) %>%
  group_by(Station, FlowMeterSpeed, WYClass, Inundation2) %>%
  summarize(n= n(),
            min.Flowdiff = min(Flowdiff),
            max.Flowdiff = max(Flowdiff),
            median.Flowdiff = median(Flowdiff),
            min.Flowdiff_s = min(Flow_s),
            max.Flowdiff_s = max(Flow_s),
            median.Flowdiff_s = median(Flow_s),
            Flow_Q1 = quantile(Flowdiff, probs = 0.25),
            Flow_Q3 = quantile(Flowdiff, probs = 0.75),
            Flow_UL = Flow_Q3 + 1.5 * (Flow_Q3-Flow_Q1),
            Flow_s_Q1 = quantile(Flow_s, probs = 0.25), 
            Flow_s_Q3 = quantile(Flow_s, probs = 0.75),
            Flow_s_UL = Flow_s_Q3 + 1.5 * (Flow_s_Q3-Flow_s_Q1),
            Flow_s_MAD = mad(Flow_s))

Flow.sum.STTD %>%
  kbl() %>%
  kable_styling()

```


```{r}
#removed meter set times that were NA due to errors in code
Flow.sum.SHR <- samp3 %>%
  left_join(inundation4) %>%
  left_join(wy)%>%
  mutate(Flow_s = Flowdiff/MeterSetTime) %>%
  group_by(Station, FlowMeterSpeed, WYClass) %>%
  filter(!is.na(Flowdiff), !is.na(MeterSetTime), Station == "SHR") %>%
  summarize(n= n(),
            min.Flowdiff = min(Flowdiff),
            max.Flowdiff = max(Flowdiff),
            median.Flowdiff = median(Flowdiff),
            min.Flowdiff_s = min(Flow_s),
            max.Flowdiff_s = max(Flow_s),
            median.Flowdiff_s = median(Flow_s),
            Flow_Q1 = quantile(Flowdiff, probs = 0.25),
            Flow_Q3 = quantile(Flowdiff, probs = 0.75),
            Flow_UL = Flow_Q3 + 1.5 * (Flow_Q3-Flow_Q1),
            Flow_s_Q1 = quantile(Flow_s, probs = 0.25), 
            Flow_s_Q3 = quantile(Flow_s, probs = 0.75),
            Flow_s_UL = Flow_s_Q3 + 1.5 * (Flow_s_Q3-Flow_s_Q1),
            Flow_s_MAD = mad(Flow_s))

Flow.sum.SHR %>%
  kbl() %>%
  kable_styling()


```

```{r}

Flow.outlier.STTD <- left_join(FM_Samp, Flow.sum.STTD) %>%
  mutate(Flow_s = Flowdiff/MeterSetTime) %>%
  filter(!is.na(Flowdiff), !is.na(Inundation2), Station=="STTD") %>%
  group_by(Station, FlowMeterSpeed, WYClass) %>%
  mutate(Flow_modZ = abs(0.6745*(Flow_s - median.Flowdiff_s)/Flow_s_MAD),
         Flow_Outlier = ifelse((Flow_s > Flow_UL) & Flow_modZ > 3.5, "Both", ifelse(Flow_s > Flow_UL, "Tukey", ifelse(Flow_modZ > 3.5, "MAD", 
                                                                                                                      "None"))))

summary(factor(Flow.outlier.STTD$Flow_Outlier))


Flow.outlier.SHR <- left_join(FM_Samp, Flow.sum.SHR) %>%
  mutate(Flow_s = Flowdiff/MeterSetTime) %>%
  filter(!is.na(Flowdiff),  Station=="SHR") %>%
  group_by(Station, FlowMeterSpeed, WYClass) %>%
  mutate(Flow_modZ = abs(0.6745*(Flow_s - median.Flowdiff_s)/Flow_s_MAD),
         Flow_Outlier = ifelse((Flow_s > Flow_UL) & Flow_modZ > 3.5, "Both", ifelse(Flow_s > Flow_UL, "Tukey", ifelse(Flow_modZ > 3.5, "MAD", 
                                                                                                                      "None"))))

summary(factor(Flow.outlier.SHR$Flow_Outlier))

```


```{r}
FlowBoxMonth1a <- ggplot(Flow.outlier.STTD) + geom_boxplot(aes(x = WYClass, y = Flow_s)) +  scale_fill_viridis(discrete = TRUE) + theme_bw() 
ggplotly(FlowBoxMonth1a)


outlierWY1a <- ggplot(Flow.outlier.STTD, aes(x = WYClass, y = Flow_s, color = Flow_Outlier)) + geom_point(size = 2.5, alpha = 0.5) +
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14), 
                     strip.text = element_text(size = 15))


outlierMonth1a <- ggplot(Flow.outlier.STTD, aes(x = Month, y = Flow_s, color = Flow_Outlier)) + geom_point(size = 2.5, alpha = 0.5) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14), 
                     strip.text = element_text(size = 15))

grid.arrange(FlowBoxMonth1a, outlierWY1a, outlierMonth1a)
```



```{r}
FlowBoxMonth1b <- ggplot(Flow.outlier.SHR) + geom_boxplot(aes(x = WYClass, y = Flow_s)) +  scale_fill_viridis(discrete = TRUE) + theme_bw() 
ggplotly(FlowBoxMonth1b)


outlierWY1b <- ggplot(Flow.outlier.SHR, aes(x = WYClass, y = Flow_s, color = Flow_Outlier)) + geom_point(size = 2.5, alpha = 0.5) +   
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14), 
                     strip.text = element_text(size = 15))


outlierMonth1b <- ggplot(Flow.outlier.SHR, aes(x = Month, y = Flow_s, color = Flow_Outlier)) + geom_point(size = 2.5, alpha = 0.5) +   
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14), 
                     strip.text = element_text(size = 15))

grid.arrange(FlowBoxMonth1b, outlierWY1b, outlierMonth1b)
```

Merge the two data frames together
```{r}
Flow.outlier <- rbind(Flow.outlier.SHR, Flow.outlier.STTD)
```

Flowmeter Flags and New Flowdiff calculated

Cutoffs based on looking at plots and Upper limits calculated above. 

Flag   | Description                | Outlier                   | Flowdiff
Flag 3 | Highly Suspect             | Both                      | < 200 or >= 70000 or >= 50000 if inundation = FALSE
Flag 2 | Suspect                    | Tukey or MAD but not Both | 200-999 
Flag 1 | Acceptable                 |                           | 
No flag| Acceptable                 | None                      | 1000-59999

Add comment about what was flagged (FM for flowmeter-related)
22. Calculate replacement values where Flag_FM = 3 or Comment_SAMP = FM
  * Replacement values are median standardized flowdiff * settime based on groupings of Station, Flowmeter Speed, Water Year Class
  
```{r}
FlowmeterQAQC <- Flow.outlier %>%
  filter(!is.na(Flowdiff), Flow_modZ>=0.00000001) %>%
  mutate(Flag_FM = ifelse(Flow_Outlier=="Both" | Flowdiff < 200 | (Flowdiff >= 50000 & Inundation2 ==FALSE) | Flowdiff >= 70000 , 3, 
                          ifelse(Flow_Outlier %in% c("Tukey", "MAD") | Flowdiff < 1000, 2,
                                 "")),
         Comment_FM = ifelse(Flag_FM %in% c(2,3), "FM", ""),
         FlowdiffAdj = ifelse(Flag_FM == 3 | Comment_SAMP == "FM", median.Flowdiff_s * SetTime, Flowdiff))
```


